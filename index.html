<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Electrify Chicago - Emission Visualizer</title>
    
    <!-- Libraries -->
    <script src="https://d3js.org/d3.v7.min.js"></script> 
    <script src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>
    
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/SVRUfmW7o8SUwESrCSx=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20n6a9c42z65Z50Qo0v/R7sR5U8i7n0s7f1lM2+fM3E=" crossorigin=""></script>

    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #000;
            overflow: hidden;
        }

        #app-container {
            position: relative;
            width: 100%;
            height: 100%;
        }

        /* --- Z-INDEX LAYERING STRATEGY ---
           1. Base: Camera or Fallback Image
           2. Effects: Smog & Vignette (Must be transparent to clicks)
           3. Map: Covers everything when active
           4. UI: Buttons, cards, overlays
        */

        .layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transition: opacity 0.3s ease; /* Faster transition */
        }

        /* LAYER 1: CONTENT (Z-Index 1) */
        #camera-fallback {
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/7/7d/Sears_Tower%2C_Wacker_Drive_and_Jackson_Boulevard%2C_Chicago%2C_IL_-_54189600901.jpg');
            background-position: center;
            background-size: cover;
            background-repeat: no-repeat;
            z-index: 1;
        }
        #video {
            object-fit: cover;
            z-index: 1;
            background: #000; /* Ensure black background if video fails */
        }

        /* LAYER 2: EFFECTS (Z-Index 10) */
        /* Note: pointer-events: none is critical so we can interact with things behind if needed */
        #vignette-layer {
            z-index: 10;
            pointer-events: none; 
            /* No transition on background to prevent "stuck" state */
        }
        #cloud-canvas {
            z-index: 11;
            pointer-events: none;
            opacity: 0.9;
        }

        /* LAYER 3: MAP (Z-Index 20) */
        #map {
            z-index: 20;
            background: #eee;
        }

        /* LAYER 4: UI (Z-Index 100) */
        .ui-element {
            z-index: 100;
            position: absolute;
        }

        /* Visibility States */
        .hidden {
            opacity: 0 !important;
            pointer-events: none !important;
        }
        .visible {
            opacity: 1 !important;
        }


        /* --- UI STYLES --- */

        /* 1. Effects Toggle (Top Left) */
        #effect-toggle-btn {
            top: 20px;
            left: 20px;
            padding: 0 16px;
            height: 40px;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.3);
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            backdrop-filter: blur(4px);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            font-size: 14px;
            transition: background 0.2s;
        }
        #effect-toggle-btn.active {
            background-color: #10b981;
            border-color: #10b981;
            color: #000;
        }

        /* 2. Top Label (Top Center) */
        #top-overlay {
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: auto;
            max-width: 60%;
            display: flex;
            justify-content: center;
            pointer-events: none; /* Let clicks pass through around the button */
        }
        #building-link {
            background-color: rgba(0, 0, 0, 0.85);
            color: #fff;
            padding: 10px 20px;
            border-radius: 30px;
            text-decoration: none;
            font-size: 1rem;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.2);
            backdrop-filter: blur(4px);
            pointer-events: auto;
        }

        /* 3. View Toggle (Top Right) */
        #view-toggle-btn {
            top: 20px;
            right: 20px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            background-color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        /* 4. Bottom Info Card */
        #info-card {
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            color: white;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.1);
            transform: translateY(150%);
            transition: transform 0.3s cubic-bezier(0.19, 1, 0.22, 1);
        }
        #info-card.card-active { transform: translateY(0); }

        .info-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #94a3b8;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }

        .rating-badge {
            padding: 2px 8px;
            border-radius: 4px;
            color: #000;
            font-weight: 800;
            font-size: 0.7rem;
            /* Removed transition to fix rapid-click color bug */
        }

        .info-main { font-size: 1rem; line-height: 1.5; color: #e2e8f0; }
        .highlight-val { color: white; font-weight: 700; }
        
        .car-comparison {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .car-grid {
            margin-top: 6px;
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
            font-size: 14px;
            line-height: 1;
            max-height: 60px;
            overflow: hidden;
        }

        /* 5. Map Legend */
        #map-legend {
            top: 90px;
            left: 10px;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            font-size: 12px;
            display: none; 
            color: #333;
            width: 120px;
        }
        .legend-item { display: flex; align-items: center; margin-bottom: 4px; }
        .legend-dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; flex-shrink: 0; }

        /* 6. Loading */
        #loading-indicator {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 15px 25px;
            border-radius: 12px;
            display: block; 
        }
    </style>
</head>
<body>

    <div id="app-container">
        
        <!-- LAYER 1: Content -->
        <div id="camera-fallback" class="layer hidden"></div>
        <video id="video" class="layer hidden" autoplay playsinline muted></video>

        <!-- LAYER 2: Effects (Always on top of video, below Map) -->
        <div id="vignette-layer" class="layer hidden"></div>
        <canvas id="cloud-canvas" class="layer hidden"></canvas>

        <!-- LAYER 3: Map -->
        <div id="map" class="layer hidden"></div>

        <!-- LAYER 4: UI Elements -->
        <button id="effect-toggle-btn" class="ui-element active">üå´Ô∏è Effects: ON</button>

        <div id="top-overlay" class="ui-element">
            <a id="building-link" href="#" target="_blank">Locating...</a>
        </div>

        <button id="view-toggle-btn" class="ui-element" title="Toggle Camera/Map">üó∫Ô∏è</button>

        <div id="info-card" class="ui-element">
            <div class="info-title">
                <span>Building Analysis</span>
                <span id="rating-badge" class="rating-badge">-</span>
            </div>
            <div id="info-content" class="info-main">
                Select a building.
            </div>
        </div>

        <div id="map-legend" class="ui-element">
            <div style="font-weight:bold; margin-bottom:5px;">GHG Intensity</div>
            <div class="legend-item"><div class="legend-dot" style="background:#10b981"></div>Top (A)</div>
            <div class="legend-item"><div class="legend-dot" style="background:#facc15"></div>Avg (B)</div>
            <div class="legend-item"><div class="legend-dot" style="background:#fb923c"></div>Below Avg (C)</div>
            <div class="legend-item"><div class="legend-dot" style="background:#ef4444"></div>Poor (D)</div>
        </div>

        <div id="loading-indicator" class="ui-element">Loading Data...</div>
    </div>

    <script>
    // --- DOM Elements ---
    const videoElement = document.getElementById('video');
    const fallbackElement = document.getElementById('camera-fallback');
    const mapElement = document.getElementById('map');
    
    // UI
    const buildingLink = document.getElementById('building-link');
    const toggleBtn = document.getElementById('view-toggle-btn');
    const effectBtn = document.getElementById('effect-toggle-btn');
    const infoCard = document.getElementById('info-card');
    const infoContent = document.getElementById('info-content');
    const ratingBadge = document.getElementById('rating-badge');
    const mapLegend = document.getElementById('map-legend');
    const loadingIndicator = document.getElementById('loading-indicator');
    
    // Effects
    const vignetteLayer = document.getElementById('vignette-layer');
    const cloudCanvas = document.getElementById('cloud-canvas');
    const ctx = cloudCanvas.getContext('2d');

    // --- State ---
    const CSV_FILE_PATH = 'https://raw.githubusercontent.com/vkoves/electrify-chicago/refs/heads/main/src/data/dist/building-benchmarks.csv'; 
    const IPLOCATE_API = 'https://iplocate.io/api/lookup'; 
    
    let allCsvData = [];
    let map;
    let markersLayer;
    let ghgIntensityStats = {};
    
    let isCameraMode = true;
    let cameraStream = null;
    let isCameraSupported = true;

    // Visuals State
    let clouds = [];
    let currentBuildingIntensity = 5.0; // Default startup intensity (Average)
    let visualsEnabled = true;
    let animationFrameId;

    // --- 1. Cloud & Atmosphere Logic ---

    function initClouds() {
        cloudCanvas.width = window.innerWidth;
        cloudCanvas.height = window.innerHeight;
        clouds = [];
        const numClouds = 25;
        for (let i = 0; i < numClouds; i++) {
            clouds.push({
                x: Math.random() * cloudCanvas.width,
                y: Math.random() * (cloudCanvas.height * 0.5), 
                size: 50 + Math.random() * 150,
                speed: 0.2 + Math.random() * 0.5,
            });
        }
        
        // Prevent multiple loops
        if (animationFrameId) cancelAnimationFrame(animationFrameId);
        animateClouds();
    }

    function animateClouds() {
        ctx.clearRect(0, 0, cloudCanvas.width, cloudCanvas.height);

        if (!visualsEnabled) {
            animationFrameId = requestAnimationFrame(animateClouds);
            return;
        }

        // --- VISUAL CALCULATION ---
        // Max reference set to boundary D (High emitter) + buffer
        const maxRef = (ghgIntensityStats.boundaryD || 20) * 1.5; 
        let normalized = currentBuildingIntensity / maxRef;
        if (normalized > 1) normalized = 1;
        if (normalized < 0) normalized = 0;

        // Smog Color Logic (White -> Dark Gray)
        // normalized=0 (Clean) => 255
        // normalized=1 (Dirty) => 50
        const grayVal = Math.floor(255 - (normalized * 205)); 
        const r = grayVal, g = grayVal, b = grayVal;

        clouds.forEach(cloud => {
            cloud.x += cloud.speed;
            if (cloud.x - cloud.size > cloudCanvas.width) cloud.x = -cloud.size;

            // Opacity Logic
            // normalized=0 => 0.05 opacity (barely visible)
            // normalized=1 => 0.8 opacity (thick smoke)
            const baseOpacity = 0.05 + (normalized * 0.75); 
            
            const gradient = ctx.createRadialGradient(cloud.x, cloud.y, 0, cloud.x, cloud.y, cloud.size);
            gradient.addColorStop(0, `rgba(${r},${g},${b}, ${baseOpacity})`);
            gradient.addColorStop(1, `rgba(${r},${g},${b}, 0)`);

            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(cloud.x, cloud.y, cloud.size, 0, Math.PI * 2);
            ctx.fill();
        });

        // Loop
        if (isCameraMode) {
            animationFrameId = requestAnimationFrame(animateClouds);
        }
    }

    function applyAtmosphereEffects() {
        // This function sets the CSS overlay (Vignette)
        if (!visualsEnabled) {
            vignetteLayer.style.background = 'none';
            return;
        }

        const maxRef = (ghgIntensityStats.boundaryD || 20) * 1.5;
        let normalized = currentBuildingIntensity / maxRef;
        if (normalized > 1) normalized = 1;

        if (normalized < 0.2) {
            // Clean: Very subtle shadow
            vignetteLayer.style.background = `radial-gradient(circle at center, transparent 60%, rgba(0,0,0,0.2) 100%)`;
        } else {
            // Dirty: Stronger, larger dark overlay
            // Opacity 0.2 to 0.9
            const opacity = 0.2 + (normalized * 0.7);
            const startPct = 60 - (normalized * 40); // Circle shrinks as it gets dirtier
            
            vignetteLayer.style.background = `radial-gradient(circle at center, transparent ${startPct}%, rgba(20, 15, 10, ${opacity}) 100%)`;
        }
    }

    // Toggle Button Logic
    effectBtn.addEventListener('click', () => {
        visualsEnabled = !visualsEnabled;
        
        if (visualsEnabled) {
            effectBtn.innerHTML = "üå´Ô∏è Effects: ON";
            effectBtn.classList.add('active');
            cloudCanvas.classList.remove('hidden');
            cloudCanvas.classList.add('visible');
            applyAtmosphereEffects(); // Re-apply current state
        } else {
            effectBtn.innerHTML = "üå´Ô∏è Effects: OFF";
            effectBtn.classList.remove('active');
            cloudCanvas.classList.remove('visible');
            cloudCanvas.classList.add('hidden');
            vignetteLayer.style.background = 'none';
        }
    });

    // --- 2. View Switching Logic ---

    function toggleView() {
        if (isCameraMode) {
            switchToMap();
        } else {
            switchToCamera();
        }
    }

    function switchToMap() {
        isCameraMode = false;
        cancelAnimationFrame(animationFrameId);

        // Hide Layers 1 & 2
        videoElement.classList.remove('visible'); videoElement.classList.add('hidden');
        fallbackElement.classList.remove('visible'); fallbackElement.classList.add('hidden');
        vignetteLayer.classList.remove('visible'); vignetteLayer.classList.add('hidden');
        cloudCanvas.classList.remove('visible'); cloudCanvas.classList.add('hidden');

        // Hide toggle button
        effectBtn.style.display = 'none';

        // Show Map (Layer 3)
        mapElement.classList.remove('hidden');
        mapElement.classList.add('visible');

        // UI Updates
        toggleBtn.textContent = "üì∑"; 
        mapLegend.style.display = 'block';

        if (cameraStream) videoElement.pause();
        setTimeout(() => { map.invalidateSize(); }, 300);
    }

    async function switchToCamera() {
        isCameraMode = true;
        initClouds();

        // Hide Map
        mapElement.classList.remove('visible');
        mapElement.classList.add('hidden');

        // UI Updates
        effectBtn.style.display = 'flex';
        toggleBtn.textContent = "üó∫Ô∏è"; 
        mapLegend.style.display = 'none';

        // Show Effects (Layer 2)
        vignetteLayer.classList.remove('hidden'); vignetteLayer.classList.add('visible');
        cloudCanvas.classList.remove('hidden'); cloudCanvas.classList.add('visible');
        
        // Re-apply darkening
        if(visualsEnabled) applyAtmosphereEffects();

        // Show Camera/Fallback (Layer 1)
        if (isCameraSupported) {
            if (videoElement.srcObject) {
                videoElement.play();
                videoElement.classList.remove('hidden'); videoElement.classList.add('visible');
            } else {
                await startCameraStream();
            }
        } else {
            fallbackElement.classList.remove('hidden'); fallbackElement.classList.add('visible');
        }
    }

    async function startCameraStream() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'environment' } 
            });
            videoElement.srcObject = stream;
            cameraStream = stream;
            isCameraSupported = true;
            videoElement.classList.remove('hidden'); videoElement.classList.add('visible');
            fallbackElement.classList.remove('visible'); fallbackElement.classList.add('hidden');
        } catch (err) {
            console.warn("Camera failed", err);
            isCameraSupported = false;
            videoElement.classList.remove('visible'); videoElement.classList.add('hidden');
            fallbackElement.classList.remove('hidden'); fallbackElement.classList.add('visible');
        }
    }

    toggleBtn.addEventListener('click', toggleView);


    // --- 3. Info Card & Grading ---

    function renderInfoCard(entry) {
        if (!entry) {
            infoCard.classList.remove('card-active');
            return;
        }

        const intensity = parseFloat(entry.GHGIntensity);
        
        if (isNaN(intensity)) {
            infoContent.innerHTML = "Data unavailable.";
            infoCard.classList.add('card-active');
            return;
        }

        // 1. Determine Grade & Colors (Synchronous, before visual updates)
        let rating = "Poor";
        let color = "#ef4444";
        let textColor = "white";

        if (ghgIntensityStats.boundaryA) {
            if (intensity <= ghgIntensityStats.boundaryA) { rating = "A - Excellent"; color = "#10b981"; textColor = "black"; }
            else if (intensity <= ghgIntensityStats.boundaryB) { rating = "B - Average"; color = "#facc15"; textColor = "black"; }
            else if (intensity <= ghgIntensityStats.boundaryC) { rating = "C - Below Avg"; color = "#fb923c"; textColor = "black"; }
            else { rating = "D - Poor"; color = "#ef4444"; textColor = "white"; }
        }

        // 2. Update Badge Immediately (No Transition)
        ratingBadge.textContent = rating;
        ratingBadge.style.backgroundColor = color;
        ratingBadge.style.color = textColor;

        // 3. Update Visuals
        currentBuildingIntensity = intensity;
        applyAtmosphereEffects(); 

        // 4. Calculate Cars
        const sliceEmissions = intensity * 2000;
        const carCount = Math.round(sliceEmissions / 4600);
        let carIcons = "";
        const maxIcons = 24; 
        const displayCount = Math.min(carCount, maxIcons);
        
        if (carCount < 1) {
            carIcons = "<span style='font-size:12px; color:#aaa'>(Less than 1 car)</span>";
        } else {
            for(let i=0; i<displayCount; i++) carIcons += "üöó ";
            if (carCount > maxIcons) {
                carIcons += `<span style="font-size:12px; color:#aaa; margin-left:4px">+ ${carCount - maxIcons} more</span>`;
            }
        }

        infoContent.innerHTML = `
            <div style="margin-bottom:4px;">
                Emission Intensity: <span class="highlight-val">${intensity.toFixed(1)}</span> kg CO2e/sq ft
            </div>
            <div class="car-comparison">
                <div style="font-size:0.85rem; color:#cbd5e1; margin-bottom:4px;">
                    Annual emissions equivalent (per 2,000 sq ft):
                </div>
                <div class="car-grid">${carIcons}</div>
            </div>
        `;
        
        infoCard.classList.add('card-active');
    }


    // --- 4. Data & Map Setup ---

    function calculateGhgStats(data) {
        const sorted = data
            .map(d => parseFloat(d.GHGIntensity))
            .filter(v => !isNaN(v) && v >= 0)
            .sort(d3.ascending);

        if (sorted.length === 0) return;

        ghgIntensityStats = {
            boundaryA: d3.quantile(sorted, 0.25), 
            boundaryB: d3.quantile(sorted, 0.50), 
            boundaryC: d3.quantile(sorted, 0.75), 
            boundaryD: d3.quantile(sorted, 0.90),
            max: d3.max(sorted)
        };
    }

    function getColor(value) {
        if (!ghgIntensityStats.max) return '#6b7280';
        if (value <= ghgIntensityStats.boundaryA) return '#10b981';
        if (value <= ghgIntensityStats.boundaryB) return '#facc15';
        if (value <= ghgIntensityStats.boundaryC) return '#fb923c';
        return '#ef4444';
    }

    function initializeMap() {
        map = L.map('map', { zoomControl: false }).setView([41.8781, -87.6298], 13); 
        L.control.zoom({ position: 'topleft' }).addTo(map);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap &copy; CARTO'
        }).addTo(map);
        markersLayer = L.layerGroup().addTo(map);
    }

    function populateMap(userLat, userLon) {
        markersLayer.clearLayers();
        L.circleMarker([userLat, userLon], { 
            radius: 8, color: '#ffffff', weight: 3, fillColor: '#2563eb', fillOpacity: 1 
        }).addTo(markersLayer).bindPopup("Your Location");

        if (!allCsvData.length) return;

        let closestEntry = null;
        let minDistance = Infinity;
        const bounds = new L.LatLngBounds();
        bounds.extend([userLat, userLon]);

        allCsvData.forEach((entry) => {
            const lat = parseFloat(entry.Latitude);
            const lon = parseFloat(entry.Longitude);
            if (isNaN(lat) || isNaN(lon)) return;

            const dist = calculateDistance(userLat, userLon, lat, lon);
            if (dist < minDistance) {
                minDistance = dist;
                closestEntry = entry;
            }

            const intensity = parseFloat(entry.GHGIntensity);
            const marker = L.circleMarker([lat, lon], {
                radius: 6, weight: 1, color: '#fff',
                fillColor: getColor(intensity), fillOpacity: 0.85
            }).addTo(markersLayer);

            marker.on('click', () => {
                updateUI(entry);
                marker.bringToFront();
                marker.setStyle({ radius: 10, weight: 3, color: '#000' });
                setTimeout(() => { marker.setStyle({ radius: 6, weight: 1, color: '#fff' }); }, 1500);
            });
            bounds.extend([lat, lon]);
        });

        if (closestEntry) updateUI(closestEntry);
        map.setView([userLat, userLon], 16);
    }

    function updateUI(entry) {
        loadingIndicator.style.display = 'none';

        if (entry.PropertyName) {
            const slug = toSlug(entry.PropertyName);
            buildingLink.textContent = entry.PropertyName;
            buildingLink.href = `https://electrifychicago.net/building/${slug}`;
        } else {
            buildingLink.textContent = "Unknown Building";
        }
        renderInfoCard(entry);
    }

    // Helpers
    function toSlug(text) { return String(text||'').toLowerCase().trim().replace(/[^a-z0-9\s-]/g, '').replace(/[\s-]+/g, '-'); }
    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; const dLat = (lat2-lat1)*(Math.PI/180); const dLon = (lon2-lon1)*(Math.PI/180);
        const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*(Math.PI/180))*Math.cos(lat2*(Math.PI/180)) * Math.sin(dLon/2)*Math.sin(dLon/2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    // --- Boot ---
    initializeMap();
    initClouds(); 
    startCameraStream();

    Papa.parse(CSV_FILE_PATH, {
        download: true, header: true, dynamicTyping: true,
        complete: function(results) {
            allCsvData = results.data.filter(d => d.Latitude && !isNaN(parseFloat(d.Latitude)));
            calculateGhgStats(allCsvData);
            
            // Default visual intensity to average so something shows
            if (ghgIntensityStats.boundaryB) currentBuildingIntensity = ghgIntensityStats.boundaryB;

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => { populateMap(pos.coords.latitude, pos.coords.longitude); },
                    () => { fetch(IPLOCATE_API).then(r=>r.json()).then(d=>populateMap(d.latitude, d.longitude)); }
                );
            } else {
                loadingIndicator.style.display = 'none';
            }
        },
        error: () => { loadingIndicator.textContent = "Error loading data"; }
    });

    window.addEventListener('resize', () => {
        cloudCanvas.width = window.innerWidth;
        cloudCanvas.height = window.innerHeight;
    });

    </script>
</body>
</html>
