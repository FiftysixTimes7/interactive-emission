<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Electrify Chicago - Emission Visualizer</title>
    
    <!-- Libraries -->
    <script src="https://d3js.org/d3.v7.min.js"></script> 
    <script src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>
    
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/SVRUfmW7o8SUwESrCSx=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20n6a9c42z65Z50Qo0v/R7sR5U8i7n0s7f1lM2+fM3E=" crossorigin=""></script>

    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #000;
            overflow: hidden;
        }

        /* --- Layers --- */
        #app-container {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .view-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transition: opacity 0.3s ease;
        }

        /* Fallback Image Layer (Demo Mode) */
        #camera-fallback {
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/7/7d/Sears_Tower%2C_Wacker_Drive_and_Jackson_Boulevard%2C_Chicago%2C_IL_-_54189600901.jpg');
            background-position: center;
            background-size: cover;
            background-repeat: no-repeat;
            z-index: 1;
            filter: brightness(0.7); 
        }

        #video {
            object-fit: cover;
            z-index: 2;
            background: transparent;
        }

        #map {
            z-index: 3;
            background: #eee;
        }

        /* State Classes */
        .hidden-layer {
            opacity: 0;
            pointer-events: none;
            z-index: 0 !important;
        }
        .active-layer {
            opacity: 1;
            pointer-events: auto;
        }
        
        #camera-fallback.active-layer { z-index: 1 !important; }
        #video.active-layer { z-index: 2 !important; }
        #map.active-layer { z-index: 3 !important; }

        /* --- UI Overlays --- */
        
        /* Top Bar */
        #top-overlay {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: auto;
            max-width: 60%;
            z-index: 20;
            display: flex;
            justify-content: center;
        }

        #building-link {
            background-color: rgba(0, 0, 0, 0.85);
            color: #fff;
            padding: 10px 20px;
            border-radius: 30px;
            text-decoration: none;
            font-size: 1rem;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.2);
            backdrop-filter: blur(4px);
            transition: all 0.2s;
        }

        #building-link:hover {
            border-color: #10b981;
            transform: translateY(-2px);
        }

        /* Toggle Button (Top Right) */
        #view-toggle-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 21;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            background-color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: transform 0.1s;
        }
        #view-toggle-btn:active { transform: scale(0.95); }
        
        /* Bottom Info Card */
        #info-card {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            color: white;
            z-index: 20;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.1);
            transform: translateY(150%);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        #info-card.visible {
            transform: translateY(0);
        }

        .info-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #9ca3af;
            margin-bottom: 8px;
        }

        .info-main {
            font-size: 1.1rem;
            line-height: 1.4;
            font-weight: 400;
        }

        .highlight-text {
            font-weight: 700;
            color: #fff;
        }

        /* Map Legend (Top Left, below zoom) */
        #map-legend {
            position: absolute;
            top: 90px; /* Positioned below standard Leaflet zoom controls */
            left: 10px;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 25;
            font-size: 12px;
            display: none; 
            color: #333;
            width: 120px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
        }
        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
            flex-shrink: 0;
        }

        #loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            z-index: 30;
            text-align: center;
            background: rgba(0,0,0,0.7);
            padding: 15px 25px;
            border-radius: 12px;
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body>

    <div id="app-container">
        <!-- View 1: Fallback Image (Demo Mode) -->
        <div id="camera-fallback" class="view-layer hidden-layer"></div>

        <!-- View 2: Camera Stream -->
        <video id="video" class="view-layer hidden-layer" autoplay playsinline muted></video>

        <!-- View 3: Map -->
        <div id="map" class="view-layer hidden-layer"></div>

        <!-- UI: Top Overlay -->
        <div id="top-overlay">
            <a id="building-link" href="#" target="_blank">Locating...</a>
        </div>

        <!-- UI: View Toggle -->
        <button id="view-toggle-btn" title="Toggle Camera/Map">üó∫Ô∏è</button>

        <!-- UI: Bottom Info Card -->
        <div id="info-card">
            <div class="info-title">Building Performance</div>
            <div id="info-content" class="info-main">
                Select a building to see analysis.
            </div>
        </div>

        <!-- Map Legend -->
        <div id="map-legend">
            <div style="font-weight:bold; margin-bottom:5px;">GHG Intensity</div>
            <div class="legend-item"><div class="legend-dot" style="background:#10b981"></div>Top (A)</div>
            <div class="legend-item"><div class="legend-dot" style="background:#facc15"></div>Avg (B)</div>
            <div class="legend-item"><div class="legend-dot" style="background:#fb923c"></div>Below Avg (C)</div>
            <div class="legend-item"><div class="legend-dot" style="background:#ef4444"></div>Poor (D)</div>
        </div>

        <!-- Loading Status -->
        <div id="loading-indicator">Loading Data...</div>
    </div>

    <script>
    // --- DOM Elements ---
    const videoElement = document.getElementById('video');
    const fallbackElement = document.getElementById('camera-fallback');
    const mapElement = document.getElementById('map');
    const buildingLink = document.getElementById('building-link');
    const toggleBtn = document.getElementById('view-toggle-btn');
    const infoCard = document.getElementById('info-card');
    const infoContent = document.getElementById('info-content');
    const mapLegend = document.getElementById('map-legend');
    const loadingIndicator = document.getElementById('loading-indicator');

    // --- Constants & State ---
    const CSV_FILE_PATH = 'https://raw.githubusercontent.com/vkoves/electrify-chicago/refs/heads/main/src/data/dist/building-benchmarks.csv'; 
    const IPLOCATE_API = 'https://iplocate.io/api/lookup'; 
    
    let allCsvData = [];
    let sortedIntensities = []; 
    let map;
    let markersLayer;
    let ghgIntensityStats = {};
    let selectedEntry = null;
    
    // View State
    let isCameraMode = true;
    let cameraStream = null;
    let isCameraSupported = true;

    // --- 1. View Controller ---

    function toggleView() {
        if (isCameraMode) {
            activateMap();
        } else {
            activateCameraMode();
        }
    }

    function activateMap() {
        isCameraMode = false;
        
        videoElement.classList.remove('active-layer');
        videoElement.classList.add('hidden-layer');
        fallbackElement.classList.remove('active-layer');
        fallbackElement.classList.add('hidden-layer');
        
        mapElement.classList.remove('hidden-layer');
        mapElement.classList.add('active-layer');
        
        toggleBtn.textContent = "üì∑"; 
        mapLegend.style.display = 'block'; 

        if (cameraStream) {
            videoElement.pause();
        }

        setTimeout(() => { map.invalidateSize(); }, 300);
    }

    async function activateCameraMode() {
        isCameraMode = true;
        
        mapElement.classList.remove('active-layer');
        mapElement.classList.add('hidden-layer');
        toggleBtn.textContent = "üó∫Ô∏è";
        mapLegend.style.display = 'none';

        if (isCameraSupported) {
            if (videoElement.srcObject) {
                videoElement.play();
                videoElement.classList.remove('hidden-layer');
                videoElement.classList.add('active-layer');
            } else {
                await startCameraStream();
            }
        } else {
            fallbackElement.classList.remove('hidden-layer');
            fallbackElement.classList.add('active-layer');
        }
    }

    async function startCameraStream() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'environment' } 
            });
            videoElement.srcObject = stream;
            cameraStream = stream;
            isCameraSupported = true;
            
            videoElement.classList.remove('hidden-layer');
            videoElement.classList.add('active-layer');
            fallbackElement.classList.add('hidden-layer');
        } catch (err) {
            console.warn("Camera access denied or failed. Switching to Demo Mode.", err);
            isCameraSupported = false;
            videoElement.classList.add('hidden-layer');
            fallbackElement.classList.remove('hidden-layer');
            fallbackElement.classList.add('active-layer');
        }
    }

    toggleBtn.addEventListener('click', toggleView);

    // Initial Start
    startCameraStream(); 


    // --- 2. Data & Statistics Logic ---

    function calculateGhgStats(data) {
        sortedIntensities = data
            .map(d => parseFloat(d.GHGIntensity))
            .filter(v => !isNaN(v) && v >= 0)
            .sort(d3.ascending);

        if (sortedIntensities.length === 0) return;

        ghgIntensityStats = {
            boundaryA: d3.quantile(sortedIntensities, 0.25), 
            boundaryB: d3.quantile(sortedIntensities, 0.50), 
            boundaryC: d3.quantile(sortedIntensities, 0.75), 
            max: d3.max(sortedIntensities)
        };
    }

    function getColor(value) {
        if (!ghgIntensityStats.max) return '#6b7280';
        if (value <= ghgIntensityStats.boundaryA) return '#10b981';
        if (value <= ghgIntensityStats.boundaryB) return '#facc15';
        if (value <= ghgIntensityStats.boundaryC) return '#fb923c';
        return '#ef4444';
    }

    // --- 3. Contextual Text Widget ---

    function renderInfoCard(entry) {
        if (!entry) {
            infoCard.classList.remove('visible');
            return;
        }

        const intensity = parseFloat(entry.GHGIntensity);
        
        if (isNaN(intensity) || sortedIntensities.length === 0) {
            infoContent.innerHTML = "Data unavailable for this building.";
            infoCard.classList.add('visible');
            return;
        }

        const rankIndex = sortedIntensities.findIndex(v => v >= intensity);
        const total = sortedIntensities.length;
        const betterThanCount = total - rankIndex;
        const percentBetter = Math.floor((betterThanCount / total) * 100);

        let rating = "";
        let colorClass = "";
        if (intensity <= ghgIntensityStats.boundaryA) { rating = "Excellent"; colorClass = "#10b981"; }
        else if (intensity <= ghgIntensityStats.boundaryB) { rating = "Average"; colorClass = "#facc15"; }
        else if (intensity <= ghgIntensityStats.boundaryC) { rating = "Below Average"; colorClass = "#fb923c"; }
        else { rating = "High Emitter"; colorClass = "#ef4444"; }

        infoContent.innerHTML = `
            <div style="margin-bottom:6px;">
                Emission Rating: <span style="color:${colorClass}; font-weight:800;">${rating}</span>
            </div>
            <div>
                This building emits <span class="highlight-text">${intensity.toFixed(1)}</span> kg CO2e/sq ft. 
                It performs better than <span class="highlight-text">${percentBetter}%</span> of tracked buildings.
            </div>
        `;
        
        infoCard.classList.add('visible');
    }

    // --- 4. Utility Functions ---

    function toSlug(text) {
        if (!text) return '';
        return String(text).toLowerCase().trim()
            .replace(/[^a-z0-9\s-]/g, '')
            .replace(/[\s-]+/g, '-');
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * (Math.PI / 180);
        const dLon = (lon2 - lon1) * (Math.PI / 180);
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                  Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) * 
                  Math.sin(dLon / 2) * Math.sin(dLon / 2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    // --- 5. Map & Data Logic ---

    function initializeMap() {
        // Initialize with Zoom Control disabled initially so we can add it manually to TopLeft
        map = L.map('map', { zoomControl: false }).setView([41.8781, -87.6298], 13); 
        
        // Add Zoom Control to Top Left
        L.control.zoom({ position: 'topleft' }).addTo(map);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap &copy; CARTO'
        }).addTo(map);
        
        markersLayer = L.layerGroup().addTo(map);
    }
    initializeMap();

    function updateUI(entry) {
        selectedEntry = entry;
        loadingIndicator.style.display = 'none';

        if (entry.PropertyName) {
            const slug = toSlug(entry.PropertyName);
            buildingLink.textContent = entry.PropertyName;
            buildingLink.href = `https://electrifychicago.net/building/${slug}`;
            buildingLink.style.pointerEvents = 'auto';
            buildingLink.style.opacity = '1';
        } else {
            buildingLink.textContent = "Unknown Building";
            buildingLink.style.pointerEvents = 'none';
            buildingLink.style.opacity = '0.7';
        }

        renderInfoCard(entry);
    }

    function populateMap(userLat, userLon) {
        markersLayer.clearLayers();

        // User Location Marker
        L.circleMarker([userLat, userLon], { 
            radius: 8, color: '#ffffff', weight: 3, fillColor: '#2563eb', fillOpacity: 1 
        }).addTo(markersLayer).bindPopup("Your Location");

        if (!allCsvData.length) return;

        let closestEntry = null;
        let minDistance = Infinity;
        const bounds = new L.LatLngBounds();
        bounds.extend([userLat, userLon]);

        allCsvData.forEach((entry) => {
            const lat = parseFloat(entry.Latitude);
            const lon = parseFloat(entry.Longitude);
            
            if (isNaN(lat) || isNaN(lon)) return;

            const dist = calculateDistance(userLat, userLon, lat, lon);
            if (dist < minDistance) {
                minDistance = dist;
                closestEntry = entry;
            }

            const intensity = parseFloat(entry.GHGIntensity);
            const color = getColor(intensity);

            const marker = L.circleMarker([lat, lon], {
                radius: 6, 
                weight: 1,
                color: '#fff',
                fillColor: color,
                fillOpacity: 0.85
            }).addTo(markersLayer);

            marker.on('click', () => {
                updateUI(entry);
                marker.bringToFront();
                marker.setStyle({ radius: 10, weight: 3, color: '#000' });
                setTimeout(() => { marker.setStyle({ radius: 6, weight: 1, color: '#fff' }); }, 1500);
            });

            bounds.extend([lat, lon]);
        });

        if (closestEntry) {
            updateUI(closestEntry);
        }
        
        map.setView([userLat, userLon], 16);
    }

    // --- 6. Initialization Flow ---

    function loadCsvData() {
        Papa.parse(CSV_FILE_PATH, {
            download: true, header: true, dynamicTyping: true,
            complete: function(results) {
                allCsvData = results.data.filter(d => d.Latitude && !isNaN(parseFloat(d.Latitude)));
                calculateGhgStats(allCsvData);
                getGeolocation();
            },
            error: (err) => {
                console.error("CSV Error:", err);
                loadingIndicator.textContent = "Error loading data";
            }
        });
    }

    function getGeolocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (pos) => populateMap(pos.coords.latitude, pos.coords.longitude),
                (err) => fallbackToIP()
            );
        } else {
            fallbackToIP();
        }
    }

    function fallbackToIP() {
        fetch(IPLOCATE_API)
            .then(res => res.json())
            .then(data => {
                if(data.latitude) populateMap(data.latitude, data.longitude);
            })
            .catch(err => {
                console.error("IP Geo Error", err);
                populateMap(41.8781, -87.6298);
            });
    }

    loadCsvData();

    </script>
</body>
</html>
